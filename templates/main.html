{% extends "layout.html" %}

{% block header %}
    <link rel="stylesheet" href="static/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col text-center">
        <!-- セッション日時 -->
        <div class="h4 mt-4">
            {{ session_timestamp }}
            <a class="btn btn-outline-secondary my-4" href="/" id="back">戻る</a>
        </div>
        <div class="h3">
            <!-- 企業名 -->
            {{ company_name }}
            <!-- 選考段階 -->
            {{ company_stage }}
        </div>
        <div class="row mt-2" id="run">
            <div class="col-5 offset-1 mt-5">
                <div id="videoPreview"></div>
            </div>
            <div class="col-5">
                <div class="row">
                    <div class="col-12">
                        <div class="card mx-auto my-4" id="card_box">
                            <div class="card-body  text-primary overflow-auto" id="sampleBox">
                                <section>
                                    <!-- 表示される文章 -->
                                    <div id="cus_voice">こちらに話した言葉が表示されます。</div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12" id="parent">
                        <div id="before_kakou">加工済み画像を表示します。</div>
                        <img id="kakou">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div id="sisei"></div>
                    </div>
                </div>
            </div>
            <div class="offset-1"></div>
            <div id="button">
                <button id="button_js" class="btn btn-success" onclick="recordButton()">START</button>
            </div>
        </div>
        <section>
            <canvas id="canvas" width="768" height="432"></canvas>
        </section>
        <section>
            <div id="result_chart" class="mt-5" style="display: none;">
                <div class="row">
                    <div class="col-6 offset-1">
                        <canvas id="myLineChart"></canvas>
                    </div>
                    <div class="col-5">
                        <canvas id="myPieChart"></canvas>
                    </div>
                    <div class="offset-1"></div>
                </div>
            </div>
        </section>
        <section>
            <div id="log" class="mt-5"></div>
        </section>
        <form action="/save" method="POST">
            <input id="session" type="text" name="session" value="" hidden>
            <input id="result" type="text" name="result" value="" hidden>
            <input id="sentence" type="text" name="sentence" value="" hidden>
            <input id="image" type="text" name="image" value="" hidden>
            <input id="save" class="btn btn-primary mx-auto my-5" type="submit" style="display: none;" value="SAVE">
        </form>
    </div>
</div>
<!-- </body>> -->
{% endblock %}

{% block script %}
<script>

    var start_time;
    var end_time;

    function recordButton(){
        if (button_js.textContent == 'START') {
            start();
            button_js.textContent = 'STOP';
            button_js.className = 'btn btn-danger';
        }
        else{
            stop();
        }
    }

    function start(){
        start_time = new Date().toLocaleString();
        wasoku_start();
        video_start();
    }

    function stop(){
        end_time = new Date().toLocaleString();
        wasoku_stop();
        video_stop();
        run.style = "display: none"
        printGraph();
        print_log();
        set_form();
    }

//-------------リザルト-------------------------------------------

function printGraph(){

    result_chart.style = "display: block"

    // 話速グラフ
    var ctx = document.getElementById("myLineChart");
    var myLineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['0', '5', '10', '15', '20', '25', '30(分 )'],
            datasets: [
                {
                    label: '話速',
                    data: [450, 360, 380, 470, 500, 450, 300, 430],
                    borderColor: "rgba(255,0,0,1)",
                    backgroundColor: "rgba(0,0,0,0)"
                },
                {
                    label: '基準',
                    data: [400, 400, 400, 400, 400, 400, 400, 400],
                    borderColor: "rgba(f,f,f,1)",
                    backgroundColor: "rgba(0,0,0,0)"
                }
            ],
        },
        options: {
            title: {
                display: true,
                text: '話速'
            },
            scales: {
                yAxes: [{
                    ticks: {
                        suggestedMax: 550,
                        suggestedMin: 250,
                        stepSize: 50,
                        callback: function (value, index, values) {
                            return value + '文字/分'
                        }
                    }
                }]
            },
        }
    });

    // 姿勢グラフ
    var ctx = document.getElementById("myPieChart");
    var myPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ["OK", "回転", "傾き",],
            datasets: [{
                backgroundColor: [
                    "#BB5179",
                    "#FAFF67",
                    "#58A27C",
                ],
                data: [48, 31, 21,]
            }]
        },
        options: {
            title: {
                display: true,
                text: '姿勢'
            }
        }
    });

}

//-------------ログ-------------------------------------------    
    var log_list = [];

    function set_log(time, type,  score, content){
        log_list.push({time: time,type: type, score: score, content: content});    
    }

    function print_log(){
        log_html = '<div class="h2">ログ</div>';
        // 開始時間 ~ 終了時間
        log_html += '<p class="h3">' + start_time + ' ~ ' + end_time + '</p>';
        // ソート
        log_list.sort(function (a, b) {
            if (a.time > b.time) {
                return 1;
            } else {
                return -1;
            }
        })
        for (let i = 0; i < log_list.length; i++){

            // ログ時刻
            log_html += '<p class="h3 mt-3">' + log_list[i].time + '</p>';

            // ログが画像の場合
            if (log_list[i].type == 'image') {
                // 画像結果
                log_html += '<p class="h4">' + log_list[i].score + '</p>';
                // 画像表示
                log_html += '<p><img src="' + log_list[i].content + '"style=" width: 45opx; transform: scaleX(-1);"></p>';
            }
            // ログが文章の場合
            else{
                // 話速
                log_html += '<p class="h4">話速：' + log_list[i].score + '</p>';
                // 文章
                log_html += '<p class="h4">' + log_list[i].content + '</p>';
            }
        }
        log.innerHTML = log_html;
    }

//-------------保存-------------------------------------------
    function set_form(){

        session.value = '{{ session_timestamp }},' + '{{ company_name }},' + '{{ company_stage }}';

        result.value = start_time  + ',' + end_time;

        for (let i = 0; i < log_list.length; i++) {
            let log = log_list[i];
            if (log.type == 'text') {
                sentence.value +=  log.time + ',' + log.content + ',' + log.score + "|";
            }
            else{
                image.value += log.time + ',' + log.content.slice(9) + ',' + log.score + "|";
            }
        }

        sentence.value = sentence.value.slice(0, sentence.value.length - 1);
        image.value = image.value.slice(0, image.value.length - 1);

        save.style = "display: block"

    }

//--------------画像判定--------------------------------------
    let timer;

    const cameraSize = { w: 768, h: 432 };
    const resolution = { w: 768, h: 432 };
    let video;
    let media;

    let videoPreviewWidth = document.getElementById('videoPreview').clientWidth;

    // video要素をつくる
    video = document.createElement('video');
    video.id = 'video';
    video.width = videoPreviewWidth;
    video.height = cameraSize.h * (videoPreviewWidth / cameraSize.w)
    video.autoplay = true;
    document.getElementById('videoPreview').appendChild(video);

    // video要素にWebカメラの映像を表示させる
    media = navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
            width: { ideal: resolution.w },
            height: { ideal: resolution.h }
        }
    }).then(function (stream) {
        video.srcObject = stream;
    });

    // img要素をつくる
    adjuster          = document.createElement('img');
    adjuster.id       = 'adjuster';
    // adjuster.src      = 'images/adjuster.png';
    adjuster.src      = '/static/asets/adjuster.png';
    adjuster.width    = videoPreviewWidth;
    adjuster.height   = cameraSize.h * (videoPreviewWidth / cameraSize.w);
    adjuster.style.zIndex = 1;
    document.getElementById('videoPreview').appendChild(adjuster);


    function video_start(){

        // キャプチャ
        let video_cap = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');

        // ajax
        let fd = new FormData();
        timer = setInterval(function(){

            // canvas要素全体に画像を描画する。
            ctx.drawImage(video_cap, 0, 0, 768, 432);

            // キャプチャ時刻
            capture_time = new Date().toLocaleTimeString();

            fd.append('image', null);

            canvas.toBlob(
                function(blob){
                    fd.set('image', blob);

                    $.ajax({
                        url: "/shoulder",
                        type : "POST",
                        processData: false,
                        contentType: false,
                        data : fd,
                        dataType: "text",
                    })
                    .done(function(data){
                        let resultObjct = data.split(",");
                        sisei.innerHTML = '<h3>' + resultObjct[0] + '</h3>';
                        kakou.src = resultObjct[1];
                        set_log(capture_time, 'image', resultObjct[0], resultObjct[1]);
                        console.log(resultObjct[0]);
                    })
                    .fail(function(data){
                        let time = new Date().toLocaleTimeString();
                        console.log(time + '画像を得られませんでした。');
                    });
                }
            , 'image/jpeg');

        }, 10000); // 画像処理スパン
    }

    function video_stop(){
            video.remove();
            clearInterval(timer);
    }

//--------------話速測定------------------------------------------

    SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
    let recognition = new SpeechRecognition();

    recognition.lang = 'ja-JP';
    recognition.interimResults = true;
    recognition.continuous = true;

    let finalTranscript = '';

    let word_time = 0.0;
    let time_head;
    let time_tail;
    let time_flag = false;
    let transcript_time;

    let sentence_list = [];

    recognition.onresult = (event) => {
        if (!time_flag) {
            transcript_time = new Date().toLocaleTimeString();
            time_head = event.timeStamp;
            time_tail = event.timeStamp;
            time_flag = true;
        }
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            let transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                word_time += time_tail - time_head;
                time_flag = false;
                finalTranscript += transcript;
                set_log(transcript_time, 'text', '' + (time_tail - time_head), transcript);
            }
            else {
                time_tail = event.timeStamp;
                interimTranscript = transcript;
            }
        }
        cus_voice.innerHTML = finalTranscript + '<i style="color:#ddd;">' + interimTranscript + '</i>';
    }

    function wasoku_start() {
        recognition.start();
    }

    function wasoku_stop() {
        recognition.stop();
        if (time_flag) {
            word_time += time_tail - time_head;
            time_flag = false;
        }
        let word = finalTranscript;
        let hiragana = HiraganaConvert(word);
        let word_length = hiragana.length;
        let wasoku = Math.round((word_length / ((word_time / 1000) / 60)));

        for (let i = 0; i  < log_list.length; i++) {

            let log = log_list[i];
            
            if (log.type == 'text') {
                let hiragana = HiraganaConvert(log.content);
                // log.content += '<br>' + hiragana + '<br>文字数：' + hiragana.length + '<br>時間：' + log.score;
                log.score =  Math.round(hiragana.length / ((parseFloat(log.score) / 1000) / 60));
            }
            
        }

    }

    function HiraganaConvert(send_word) {

        let hiragana = send_word;

        let json = JSON.stringify({
            app_id: "f192486406c327292ce7cc842a7e4eea482fb063c9b023d6dbd3c6339d376ab5",
            request_id: "record",
            sentence: send_word,
            output_type: "hiragana"
        });

        let xhr = new XMLHttpRequest;

        xhr.open("POST", "https://labs.goo.ne.jp/api/hiragana", false);
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');

        try {
            xhr.send(json);
            if (xhr.status != 200) {
                alert(`Error ${xhr.status}: ${xhr.statusText}`);
            } else {
                let res = JSON.parse(xhr.responseText);
                hiragana = res.converted.replace(/\s+/g, '');
            }
        } catch (err) {
            ("Request failed");
        }

        return hiragana;

    }

    // 俺様専用スクリプト
    function sample(){
        start_time = '09:00:00';
        end_time = '10:00:00';
        set_log('09:10:10', 'image', 'OK', './static/images/20201211_102327.jpg');
        set_log('09:10:00', 'text', 350, 'おはようございます。本日は宜しくお願いいたします。');
        set_log('09:30:10', 'image', '右に15度傾いています', './static/images/20201211_102337.jpg');
        set_log('09:30:00', 'text', 400, '私の強みは問題解決能力があるところです。私は大学時代バスケットボール部に所属していました。部のなかで、私は練習メニューを考えることに力を入れていました。試合結果を分析して課題と改善点を打ち出すことで、チームの底上げになる練習メニューを考え取り入れていました。');
        set_log('09:50:00', 'text', 350, '本日は誠にありがとうございました。');
        run.style = "display: none"
        printGraph();
        print_log();
        set_form();
        video.remove();
    }

    // sample();

</script>
{% endblock %}
